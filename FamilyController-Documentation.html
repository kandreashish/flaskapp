<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Controller API Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            margin-top: 20px;
            margin-bottom: 20px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            margin: -20px -20px 40px -20px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .toc {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .toc h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .toc ul {
            list-style: none;
            columns: 2;
            column-gap: 30px;
        }

        .toc li {
            margin-bottom: 8px;
            break-inside: avoid;
        }

        .toc a {
            color: #495057;
            text-decoration: none;
            font-weight: 500;
            padding: 5px 0;
            display: block;
            transition: color 0.3s ease;
        }

        .toc a:hover {
            color: #667eea;
            text-decoration: underline;
        }

        .section {
            margin-bottom: 50px;
            padding: 25px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .section h2 {
            color: #667eea;
            font-size: 1.8rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .section h3 {
            color: #495057;
            font-size: 1.4rem;
            margin: 25px 0 15px 0;
        }

        .section h4 {
            color: #6c757d;
            font-size: 1.1rem;
            margin: 15px 0 10px 0;
        }

        .endpoint {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .endpoint:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .method {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.85rem;
            margin-right: 10px;
            text-transform: uppercase;
        }

        .method.post { background: #28a745; color: white; }
        .method.get { background: #007bff; color: white; }
        .method.put { background: #ffc107; color: black; }
        .method.delete { background: #dc3545; color: white; }

        .endpoint-url {
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            color: #495057;
            font-weight: 600;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 15px 0;
            position: relative;
        }

        .code-block::before {
            content: 'JSON';
            position: absolute;
            top: 5px;
            right: 10px;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .validation-rules {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        .validation-rules h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .validation-rules ul {
            margin-left: 20px;
        }

        .validation-rules li {
            color: #856404;
            margin-bottom: 5px;
        }

        .response-example {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        .response-example h4 {
            color: #0c5460;
            margin-bottom: 10px;
        }

        .error-responses {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        .error-responses h4 {
            color: #721c24;
            margin-bottom: 10px;
        }

        .constants {
            background: #e2e3e5;
            border: 1px solid #d1d3d4;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        .constants h4 {
            color: #383d41;
            margin-bottom: 10px;
        }

        .constants ul {
            margin-left: 20px;
            list-style-type: disc;
        }

        .constants li {
            margin-bottom: 5px;
            color: #495057;
        }

        .data-models {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        .data-models h4 {
            color: #155724;
            margin-bottom: 10px;
        }

        .parameter {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 0 5px 5px 0;
        }

        .parameter-name {
            font-weight: bold;
            color: #667eea;
        }

        .parameter-type {
            font-style: italic;
            color: #6c757d;
        }

        .parameter-description {
            margin-top: 5px;
            color: #495057;
        }

        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #667eea;
            color: white;
            padding: 12px 15px;
            border-radius: 50%;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .back-to-top:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .toc ul {
                columns: 1;
            }

            .code-block {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Family Controller API</h1>
            <p>Comprehensive documentation for all family management endpoints</p>
        </div>

        <div class="toc" id="table-of-contents">
            <h2>üìã Table of Contents</h2>
            <ul>
                <li><a href="#overview">Overview</a></li>
                <li><a href="#constants">Constants & Configuration</a></li>
                <li><a href="#data-models">Data Models</a></li>
                <li><a href="#create-family">Create Family</a></li>
                <li><a href="#join-family">Join Family</a></li>
                <li><a href="#leave-family">Leave Family</a></li>
                <li><a href="#get-details">Get Family Details</a></li>
                <li><a href="#invite-member">Invite Member</a></li>
                <li><a href="#request-join">Request to Join</a></li>
                <li><a href="#accept-join-request">Accept Join Request</a></li>
                <li><a href="#accept-invitation">Accept Invitation</a></li>
                <li><a href="#reject-join-request">Reject Join Request</a></li>
                <li><a href="#remove-member">Remove Member</a></li>
                <li><a href="#cancel-invitation">Cancel Invitation</a></li>
                <li><a href="#resend-invitation">Resend Invitation</a></li>
                <li><a href="#validation-rules">Validation Rules</a></li>
                <li><a href="#error-handling">Error Handling</a></li>
                <li><a href="#notification-system">Notification System</a></li>
            </ul>
        </div>

        <div class="section" id="overview">
            <h2>üîç Overview</h2>
            <p>The Family Controller manages all family-related operations in the expense tracker application. It provides endpoints for creating families, managing members, handling invitations, and managing join requests.</p>

            <h3>Base URL</h3>
            <div class="code-block">/api/family</div>

            <h3>Authentication</h3>
            <p>All endpoints require authentication. The current user ID is extracted from the authentication context using <code>AuthUtil.getCurrentUserId()</code>.</p>
        </div>

        <div class="section" id="constants">
            <h2>‚öôÔ∏è Constants & Configuration</h2>
            <div class="constants">
                <h4>System Constants</h4>
                <ul>
                    <li><strong>FAMILY_ALIAS_LENGTH:</strong> 6 characters</li>
                    <li><strong>FAMILY_MAX_SIZE:</strong> 10 members</li>
                    <li><strong>MAX_GENERATION_ATTEMPTS:</strong> 100 attempts for unique alias generation</li>
                    <li><strong>FAMILY_NAME_MAX_LENGTH:</strong> 100 characters</li>
                    <li><strong>FAMILY_NAME_MIN_LENGTH:</strong> 2 characters</li>
                </ul>
            </div>
        </div>

        <div class="section" id="data-models">
            <h2>üìä Data Models</h2>

            <h3>Request Models</h3>

            <h4>CreateFamilyRequest</h4>
            <div class="code-block">{
  "familyName": "string (2-100 chars, required)"
}</div>

            <h4>JoinFamilyRequest</h4>
            <div class="code-block">{
  "aliasName": "string (6 chars uppercase/numbers, required)"
}</div>

            <h4>InviteMemberRequest</h4>
            <div class="code-block">{
  "invitedMemberEmail": "string (valid email, required)"
}</div>

            <h4>AcceptJoinRequestRequest</h4>
            <div class="code-block">{
  "requesterEmail": "string (valid email, required)"
}</div>

            <h4>RemoveMemberRequest</h4>
            <div class="code-block">{
  "memberEmail": "string (valid email, required)"
}</div>

            <h4>RejectJoinRequestRequest</h4>
            <div class="code-block">{
  "requesterEmail": "string (valid email, required)"
}</div>

            <h4>CancelInvitationRequest</h4>
            <div class="code-block">{
  "invitedMemberEmail": "string (valid email, required)"
}</div>

            <h3>Response Models</h3>

            <h4>BasicFamilySuccessResponse</h4>
            <div class="code-block">{
  "message": "string",
  "family": {
    "familyId": "string",
    "headId": "string",
    "name": "string",
    "aliasName": "string",
    "maxSize": "number",
    "membersIds": ["string"],
    "pendingMemberEmails": ["string"],
    "pendingJoinRequests": ["string"],
    "updatedAt": "number"
  }
}</div>

            <h4>Family Model</h4>
            <div class="code-block">{
  "familyId": "string (UUID)",
  "headId": "string (User ID of family head)",
  "name": "string (Family name)",
  "aliasName": "string (6-char unique identifier)",
  "maxSize": "number (Maximum family size)",
  "membersIds": ["string (Array of member user IDs)"],
  "pendingMemberEmails": ["string (Pending invitations)"],
  "pendingJoinRequests": ["string (Pending join requests)"],
  "updatedAt": "number (Timestamp)"
}</div>
        </div>

        <div class="section" id="create-family">
            <h2>üèóÔ∏è Create Family</h2>
            <div class="endpoint">
                <span class="method post">POST</span>
                <span class="endpoint-url">/api/family/create</span>
            </div>

            <h3>Description</h3>
            <p>Creates a new family with the authenticated user as the family head. Generates a unique 6-character alias for the family.</p>

            <h3>Request Body</h3>
            <div class="code-block">{
  "familyName": "My Family"
}</div>

            <div class="validation-rules">
                <h4>üîç Validation Rules</h4>
                <ul>
                    <li>Family name is required (non-blank)</li>
                    <li>Length must be between 2-100 characters</li>
                    <li>No leading or trailing spaces</li>
                    <li>Only alphanumeric characters, spaces, hyphens, and underscores allowed</li>
                    <li>User must not already belong to a family</li>
                </ul>
            </div>

            <div class="response-example">
                <h4>‚úÖ Success Response (200)</h4>
                <div class="code-block">{
  "familyId": "uuid-string",
  "headId": "user-id",
  "name": "My Family",
  "aliasName": "ABC123",
  "maxSize": 10,
  "membersIds": ["user-id"],
  "pendingMemberEmails": [],
  "pendingJoinRequests": [],
  "updatedAt": 1642099200000
}</div>
            </div>

            <div class="error-responses">
                <h4>‚ùå Error Responses</h4>
                <ul>
                    <li><strong>400:</strong> Invalid family name or user already in family</li>
                    <li><strong>404:</strong> User not found</li>
                    <li><strong>409:</strong> User already belongs to a family</li>
                    <li><strong>500:</strong> Server error during family creation</li>
                </ul>
            </div>
        </div>

        <div class="section" id="join-family">
            <h2>üö™ Join Family</h2>
            <div class="endpoint">
                <span class="method post">POST</span>
                <span class="endpoint-url">/api/family/join</span>
            </div>

            <h3>Description</h3>
            <p>Allows a user to directly join a family using its alias name. The user is immediately added to the family without requiring approval.</p>

            <h3>Request Body</h3>
            <div class="code-block">{
  "aliasName": "ABC123"
}</div>

            <div class="validation-rules">
                <h4>üîç Validation Rules</h4>
                <ul>
                    <li>Alias name must be exactly 6 characters</li>
                    <li>Only uppercase letters and numbers allowed</li>
                    <li>User must not already belong to a family</li>
                    <li>Family must exist and not be full</li>
                </ul>
            </div>

            <div class="response-example">
                <h4>‚úÖ Success Response (200)</h4>
                <div class="code-block">{
  "familyId": "uuid-string",
  "headId": "head-user-id",
  "name": "Family Name",
  "aliasName": "ABC123",
  "maxSize": 10,
  "membersIds": ["head-user-id", "new-user-id"],
  "pendingMemberEmails": [],
  "pendingJoinRequests": [],
  "updatedAt": 1642099200000
}</div>
            </div>

            <div class="error-responses">
                <h4>‚ùå Error Responses</h4>
                <ul>
                    <li><strong>400:</strong> Invalid alias name or user already in family</li>
                    <li><strong>404:</strong> User or family not found</li>
                    <li><strong>409:</strong> User already belongs to family or family is full</li>
                    <li><strong>500:</strong> Server error during join operation</li>
                </ul>
            </div>
        </div>

        <div class="section" id="leave-family">
            <h2>üö∂‚Äç‚ôÇÔ∏è Leave Family</h2>
            <div class="endpoint">
                <span class="method post">POST</span>
                <span class="endpoint-url">/api/family/leave</span>
            </div>

            <h3>Description</h3>
            <p>Removes the authenticated user from their current family. If the user is the family head and other members exist, the first remaining member becomes the new head. If no members remain, the family is deleted.</p>

            <h3>Request Body</h3>
            <p>No request body required.</p>

            <div class="validation-rules">
                <h4>üîç Validation Rules</h4>
                <ul>
                    <li>User must belong to a family</li>
                    <li>User must be a member of the family</li>
                </ul>
            </div>

            <div class="response-example">
                <h4>‚úÖ Success Response (200) - Family Still Exists</h4>
                <div class="code-block">{
  "message": "Left family successfully",
  "family": {
    "familyId": "uuid-string",
    "headId": "new-head-user-id",
    "name": "Family Name",
    "aliasName": "ABC123",
    "maxSize": 10,
    "membersIds": ["remaining-user-id"],
    "pendingMemberEmails": [],
    "pendingJoinRequests": [],
    "updatedAt": 1642099200000
  }
}</div>
            </div>

            <div class="response-example">
                <h4>‚úÖ Success Response (200) - Family Deleted</h4>
                <div class="code-block">{
  "message": "Left family successfully - family deleted as no members remain"
}</div>
            </div>

            <div class="error-responses">
                <h4>‚ùå Error Responses</h4>
                <ul>
                    <li><strong>400:</strong> User not in family or not a member</li>
                    <li><strong>404:</strong> User or family not found</li>
                    <li><strong>500:</strong> Server error during leave operation</li>
                </ul>
            </div>
        </div>

        <div class="section" id="get-details">
            <h2>üìã Get Family Details</h2>
            <div class="endpoint">
                <span class="method get">GET</span>
                <span class="endpoint-url">/api/family/details</span>
            </div>

            <h3>Description</h3>
            <p>Retrieves complete family information including family details and all member information for the authenticated user's family.</p>

            <h3>Request Parameters</h3>
            <p>No parameters required.</p>

            <div class="validation-rules">
                <h4>üîç Validation Rules</h4>
                <ul>
                    <li>User must belong to a family</li>
                </ul>
            </div>

            <div class="response-example">
                <h4>‚úÖ Success Response (200)</h4>
                <div class="code-block">{
  "family": {
    "familyId": "uuid-string",
    "headId": "head-user-id",
    "name": "Family Name",
    "aliasName": "ABC123",
    "maxSize": 10,
    "membersIds": ["user1-id", "user2-id"],
    "pendingMemberEmails": ["invite@example.com"],
    "pendingJoinRequests": ["request@example.com"],
    "updatedAt": 1642099200000
  },
  "members": [
    {
      "id": "user1-id",
      "name": "John Doe",
      "email": "john@example.com",
      "familyId": "uuid-string",
      "updatedAt": 1642099200000
    },
    {
      "id": "user2-id",
      "name": "Jane Doe",
      "email": "jane@example.com",
      "familyId": "uuid-string",
      "updatedAt": 1642099200000
    }
  ]
}</div>
            </div>

            <div class="error-responses">
                <h4>‚ùå Error Responses</h4>
                <ul>
                    <li><strong>400:</strong> User does not belong to any family</li>
                    <li><strong>404:</strong> User or family not found</li>
                    <li><strong>500:</strong> Server error during retrieval</li>
                </ul>
            </div>
        </div>

        <div class="section" id="invite-member">
            <h2>‚úâÔ∏è Invite Member</h2>
            <div class="endpoint">
                <span class="method post">POST</span>
                <span class="endpoint-url">/api/family/invite</span>
            </div>

            <h3>Description</h3>
            <p>Sends an invitation to a user to join the family. Only family heads can send invitations. The invited user receives a push notification and the invitation is added to pending emails.</p>

            <h3>Request Body</h3>
            <div class="code-block">{
  "invitedMemberEmail": "newmember@example.com"
}</div>

            <div class="validation-rules">
                <h4>üîç Validation Rules</h4>
                <ul>
                    <li>Valid email format required</li>
                    <li>Only family head can send invitations</li>
                    <li>Invited user must exist in the system</li>
                    <li>Invited user must not already belong to a family</li>
                    <li>User must not already be invited (no duplicate invitations)</li>
                </ul>
            </div>

            <div class="response-example">
                <h4>‚úÖ Success Response (200)</h4>
                <div class="code-block">{
  "message": "Invitation sent to newmember@example.com and is pending acceptance",
  "family": {
    "familyId": "uuid-string",
    "headId": "head-user-id",
    "name": "Family Name",
    "aliasName": "ABC123",
    "maxSize": 10,
    "membersIds": ["head-user-id"],
    "pendingMemberEmails": ["newmember@example.com"],
    "pendingJoinRequests": [],
    "updatedAt": 1642099200000
  }
}</div>
            </div>

            <div class="error-responses">
                <h4>‚ùå Error Responses</h4>
                <ul>
                    <li><strong>400:</strong> Invalid email format</li>
                    <li><strong>403:</strong> User is not the family head</li>
                    <li><strong>404:</strong> User, family, or invited user not found</li>
                    <li><strong>409:</strong> Invited user already in family or already invited</li>
                    <li><strong>500:</strong> Server error during invitation</li>
                </ul>
            </div>

            <h3>üîî Notification Details</h3>
            <p>The invited user receives:</p>
            <ul>
                <li><strong>Push Notification:</strong> "Family Invitation" with family and sender details</li>
                <li><strong>In-App Notification:</strong> Actionable notification with invitation details</li>
            </ul>
        </div>

        <div class="section" id="request-join">
            <h2>üôã‚Äç‚ôÇÔ∏è Request to Join Family</h2>
            <div class="endpoint">
                <span class="method post">POST</span>
                <span class="endpoint-url">/api/family/request-join</span>
            </div>

            <h3>Description</h3>
            <p>Allows a user to request permission to join a family using its alias. The family head receives a notification and can approve or reject the request.</p>

            <h3>Request Body</h3>
            <div class="code-block">{
  "aliasName": "ABC123"
}</div>

            <div class="validation-rules">
                <h4>üîç Validation Rules</h4>
                <ul>
                    <li>Alias name must be exactly 6 characters</li>
                    <li>Only uppercase letters and numbers allowed</li>
                    <li>User must not already belong to a family</li>
                    <li>Family must exist and not be full</li>
                    <li>User must not have already requested to join this family</li>
                </ul>
            </div>

            <div class="response-example">
                <h4>‚úÖ Success Response (200)</h4>
                <div class="code-block">{
  "message": "Join request sent to family head",
  "family": {
    "familyId": "uuid-string",
    "headId": "head-user-id",
    "name": "Family Name",
    "aliasName": "ABC123",
    "maxSize": 10,
    "membersIds": ["head-user-id"],
    "pendingMemberEmails": [],
    "pendingJoinRequests": ["requester@example.com"],
    "updatedAt": 1642099200000
  }
}</div>
            </div>

            <div class="error-responses">
                <h4>‚ùå Error Responses</h4>
                <ul>
                    <li><strong>400:</strong> Invalid alias or user already in family</li>
                    <li><strong>404:</strong> User or family not found</li>
                    <li><strong>409:</strong> User already requested, family full, or user already in family</li>
                    <li><strong>500:</strong> Server error during request</li>
                </ul>
            </div>

            <h3>üîî Notification Details</h3>
            <p>The family head receives:</p>
            <ul>
                <li><strong>Push Notification:</strong> "Join Request" with requester details</li>
                <li><strong>In-App Notification:</strong> Notification with request details</li>
            </ul>
        </div>

        <div class="section" id="accept-join-request">
            <h2>‚úÖ Accept Join Request</h2>
            <div class="endpoint">
                <span class="method post">POST</span>
                <span class="endpoint-url">/api/family/accept-join-request</span>
            </div>

            <h3>Description</h3>
            <p>Allows family heads to accept pending join requests. The requesting user is added to the family and receives a notification.</p>

            <h3>Request Body</h3>
            <div class="code-block">{
  "requesterEmail": "requester@example.com"
}</div>

            <div class="validation-rules">
                <h4>üîç Validation Rules</h4>
                <ul>
                    <li>Valid email format required</li>
                    <li>Only family head can accept requests</li>
                    <li>Join request must exist for the specified email</li>
                    <li>Requesting user must still exist and not belong to another family</li>
                    <li>Family must not be full</li>
                </ul>
            </div>

            <div class="response-example">
                <h4>‚úÖ Success Response (200)</h4>
                <div class="code-block">{
  "message": "User added to family and notified",
  "family": {
    "familyId": "uuid-string",
    "headId": "head-user-id",
    "name": "Family Name",
    "aliasName": "ABC123",
    "maxSize": 10,
    "membersIds": ["head-user-id", "new-member-id"],
    "pendingMemberEmails": [],
    "pendingJoinRequests": [],
    "updatedAt": 1642099200000
  }
}</div>
            </div>

            <div class="error-responses">
                <h4>‚ùå Error Responses</h4>
                <ul>
                    <li><strong>400:</strong> Invalid email format</li>
                    <li><strong>403:</strong> User is not the family head</li>
                    <li><strong>404:</strong> User, family, requesting user, or join request not found</li>
                    <li><strong>409:</strong> Requesting user already in family or family is full</li>
                    <li><strong>500:</strong> Server error during acceptance</li>
                </ul>
            </div>

            <h3>üîî Notification Details</h3>
            <p>The requesting user receives:</p>
            <ul>
                <li><strong>Push Notification:</strong> "Join Request Accepted" with family details</li>
                <li><strong>In-App Notification:</strong> Confirmation of acceptance</li>
            </ul>
        </div>

        <div class="section" id="accept-invitation">
            <h2>üì® Accept Invitation</h2>
            <div class="endpoint">
                <span class="method post">POST</span>
                <span class="endpoint-url">/api/family/accept-invitation</span>
            </div>

            <h3>Description</h3>
            <p>Allows an invited user to accept a family invitation using the family's alias. The user is added to the family and the family head is notified.</p>

            <h3>Request Body</h3>
            <div class="code-block">{
  "aliasName": "ABC123"
}</div>

            <div class="validation-rules">
                <h4>üîç Validation Rules</h4>
                <ul>
                    <li>Alias name must be exactly 6 characters</li>
                    <li>Only uppercase letters and numbers allowed</li>
                    <li>User must not already belong to a family</li>
                    <li>Invitation must exist for the user's email</li>
                    <li>Family must not be full</li>
                </ul>
            </div>

            <div class="response-example">
                <h4>‚úÖ Success Response (200)</h4>
                <div class="code-block">{
  "message": "Joined family and head notified",
  "family": {
    "familyId": "uuid-string",
    "headId": "head-user-id",
    "name": "Family Name",
    "aliasName": "ABC123",
    "maxSize": 10,
    "membersIds": ["head-user-id", "new-member-id"],
    "pendingMemberEmails": [],
    "pendingJoinRequests": [],
    "updatedAt": 1642099200000
  }
}</div>
            </div>

            <div class="error-responses">
                <h4>‚ùå Error Responses</h4>
                <ul>
                    <li><strong>400:</strong> Invalid alias or user already in family</li>
                    <li><strong>404:</strong> User, family, or invitation not found</li>
                    <li><strong>409:</strong> User already in family or family is full</li>
                    <li><strong>500:</strong> Server error during acceptance</li>
                </ul>
            </div>

            <h3>üîî Notification Details</h3>
            <p>The family head receives:</p>
            <ul>
                <li><strong>Push Notification:</strong> "Invitation Accepted" with new member details</li>
                <li><strong>In-App Notification:</strong> Confirmation of new member joining</li>
            </ul>
        </div>

        <div class="section" id="reject-join-request">
            <h2>‚ùå Reject Join Request</h2>
            <div class="endpoint">
                <span class="method post">POST</span>
                <span class="endpoint-url">/api/family/reject-join-request</span>
            </div>

            <h3>Description</h3>
            <p>Allows family heads to reject pending join requests. The requesting user is notified of the rejection.</p>

            <h3>Request Body</h3>
            <div class="code-block">{
  "requesterEmail": "requester@example.com"
}</div>

            <div class="validation-rules">
                <h4>üîç Validation Rules</h4>
                <ul>
                    <li>Valid email format required</li>
                    <li>Only family head can reject requests</li>
                    <li>Join request must exist for the specified email</li>
                </ul>
            </div>

            <div class="response-example">
                <h4>‚úÖ Success Response (200)</h4>
                <div class="code-block">{
  "message": "Join request rejected successfully",
  "family": {
    "familyId": "uuid-string",
    "headId": "head-user-id",
    "name": "Family Name",
    "aliasName": "ABC123",
    "maxSize": 10,
    "membersIds": ["head-user-id"],
    "pendingMemberEmails": [],
    "pendingJoinRequests": [],
    "updatedAt": 1642099200000
  }
}</div>
            </div>

            <div class="error-responses">
                <h4>‚ùå Error Responses</h4>
                <ul>
                    <li><strong>400:</strong> Invalid email format</li>
                    <li><strong>403:</strong> User is not the family head</li>
                    <li><strong>404:</strong> User, family, or join request not found</li>
                    <li><strong>500:</strong> Server error during rejection</li>
                </ul>
            </div>

            <h3>üîî Notification Details</h3>
            <p>The requesting user receives:</p>
            <ul>
                <li><strong>Push Notification:</strong> "Join Request Rejected" with family details</li>
                <li><strong>In-App Notification:</strong> Notification of rejection</li>
            </ul>
        </div>

        <div class="section" id="remove-member">
            <h2>üö´ Remove Member</h2>
            <div class="endpoint">
                <span class="method post">POST</span>
                <span class="endpoint-url">/api/family/remove-member</span>
            </div>

            <h3>Description</h3>
            <p>Allows family heads to remove members from the family. The family head cannot remove themselves - they must use the leave family endpoint instead.</p>

            <h3>Request Body</h3>
            <div class="code-block">{
  "memberEmail": "member@example.com"
}</div>

            <div class="validation-rules">
                <h4>üîç Validation Rules</h4>
                <ul>
                    <li>Valid email format required</li>
                    <li>Only family head can remove members</li>
                    <li>Member must exist and belong to the family</li>
                    <li>Family head cannot remove themselves</li>
                    <li>Member must be in the family's member list</li>
                </ul>
            </div>

            <div class="response-example">
                <h4>‚úÖ Success Response (200)</h4>
                <div class="code-block">{
  "message": "Member removed from family successfully",
  "family": {
    "familyId": "uuid-string",
    "headId": "head-user-id",
    "name": "Family Name",
    "aliasName": "ABC123",
    "maxSize": 10,
    "membersIds": ["head-user-id"],
    "pendingMemberEmails": [],
    "pendingJoinRequests": [],
    "updatedAt": 1642099200000
  }
}</div>
            </div>

            <div class="error-responses">
                <h4>‚ùå Error Responses</h4>
                <ul>
                    <li><strong>400:</strong> Invalid email, head removing self, or member not in family</li>
                    <li><strong>403:</strong> User is not the family head</li>
                    <li><strong>404:</strong> User, family, or member not found</li>
                    <li><strong>500:</strong> Server error during removal</li>
                </ul>
            </div>

            <h3>üîî Notification Details</h3>
            <p>The removed member receives:</p>
            <ul>
                <li><strong>Push Notification:</strong> "Removed from Family" with family details</li>
                <li><strong>In-App Notification:</strong> Notification of removal</li>
            </ul>
        </div>

        <div class="section" id="cancel-invitation">
            <h2>üîÑ Cancel Invitation</h2>
            <div class="endpoint">
                <span class="method post">POST</span>
                <span class="endpoint-url">/api/family/cancel-invitation</span>
            </div>

            <h3>Description</h3>
            <p>Allows family heads to cancel pending invitations. The invited user is notified of the cancellation.</p>

            <h3>Request Body</h3>
            <div class="code-block">{
  "invitedMemberEmail": "invited@example.com"
}</div>

            <div class="validation-rules">
                <h4>üîç Validation Rules</h4>
                <ul>
                    <li>Valid email format required</li>
                    <li>Only family head can cancel invitations</li>
                    <li>Pending invitation must exist for the specified email</li>
                </ul>
            </div>

            <div class="response-example">
                <h4>‚úÖ Success Response (200)</h4>
                <div class="code-block">{
  "message": "Invitation cancelled successfully",
  "family": {
    "familyId": "uuid-string",
    "headId": "head-user-id",
    "name": "Family Name",
    "aliasName": "ABC123",
    "maxSize": 10,
    "membersIds": ["head-user-id"],
    "pendingMemberEmails": [],
    "pendingJoinRequests": [],
    "updatedAt": 1642099200000
  }
}</div>
            </div>

            <div class="error-responses">
                <h4>‚ùå Error Responses</h4>
                <ul>
                    <li><strong>400:</strong> Invalid email format</li>
                    <li><strong>403:</strong> User is not the family head</li>
                    <li><strong>404:</strong> User, family, or invitation not found</li>
                    <li><strong>500:</strong> Server error during cancellation</li>
                </ul>
            </div>

            <h3>üîî Notification Details</h3>
            <p>The invited user receives:</p>
            <ul>
                <li><strong>Push Notification:</strong> "Invitation Cancelled" with family details</li>
                <li><strong>In-App Notification:</strong> Notification of cancellation</li>
            </ul>
        </div>

        <div class="section" id="resend-invitation">
            <h2>üîÅ Resend Invitation</h2>
            <div class="endpoint">
                <span class="method post">POST</span>
                <span class="endpoint-url">/api/family/resend-invitation</span>
            </div>

            <h3>Description</h3>
            <p>Allows family heads to resend existing invitations. The invitation must already exist in the pending list.</p>

            <h3>Request Body</h3>
            <div class="code-block">{
  "invitedMemberEmail": "invited@example.com"
}</div>

            <div class="validation-rules">
                <h4>üîç Validation Rules</h4>
                <ul>
                    <li>Valid email format required</li>
                    <li>Only family head can resend invitations</li>
                    <li>Pending invitation must exist for the specified email</li>
                    <li>Invited user must still exist and not belong to another family</li>
                </ul>
            </div>

            <div class="response-example">
                <h4>‚úÖ Success Response (200)</h4>
                <div class="code-block">{
  "message": "Invitation resent to invited@example.com successfully",
  "family": {
    "familyId": "uuid-string",
    "headId": "head-user-id",
    "name": "Family Name",
    "aliasName": "ABC123",
    "maxSize": 10,
    "membersIds": ["head-user-id"],
    "pendingMemberEmails": ["invited@example.com"],
    "pendingJoinRequests": [],
    "updatedAt": 1642099200000
  }
}</div>
            </div>

            <div class="error-responses">
                <h4>‚ùå Error Responses</h4>
                <ul>
                    <li><strong>400:</strong> Invalid email format</li>
                    <li><strong>403:</strong> User is not the family head</li>
                    <li><strong>404:</strong> User, family, invited user, or invitation not found</li>
                    <li><strong>409:</strong> Invited user already belongs to a family</li>
                    <li><strong>500:</strong> Server error during resend</li>
                </ul>
            </div>

            <h3>üîî Notification Details</h3>
            <p>The invited user receives:</p>
            <ul>
                <li><strong>Push Notification:</strong> "Family Invitation" (same as original invitation)</li>
                <li><strong>In-App Notification:</strong> Fresh actionable notification</li>
            </ul>
        </div>

        <div class="section" id="validation-rules">
            <h2>üîç Validation Rules</h2>

            <h3>Family Name Validation</h3>
            <div class="validation-rules">
                <h4>Rules</h4>
                <ul>
                    <li>Cannot be blank or empty</li>
                    <li>Minimum length: 2 characters</li>
                    <li>Maximum length: 100 characters</li>
                    <li>No leading or trailing spaces</li>
                    <li>Allowed characters: alphanumeric, spaces, hyphens (-), underscores (_)</li>
                    <li>Pattern: <code>^[a-zA-Z0-9\\s\\-_]+$</code></li>
                </ul>
            </div>

            <h3>Email Validation</h3>
            <div class="validation-rules">
                <h4>Rules</h4>
                <ul>
                    <li>Cannot be blank or empty</li>
                    <li>Must follow valid email format</li>
                    <li>Maximum length: 254 characters</li>
                    <li>Pattern: <code>^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$</code></li>
                </ul>
            </div>

            <h3>Alias Name Validation</h3>
            <div class="validation-rules">
                <h4>Rules</h4>
                <ul>
                    <li>Cannot be blank or empty</li>
                    <li>Must be exactly 6 characters</li>
                    <li>Only uppercase letters (A-Z) and numbers (0-9) allowed</li>
                    <li>Pattern: <code>^[A-Z0-9]+$</code></li>
                    <li>Must be unique across all families</li>
                </ul>
            </div>

            <h3>Business Rules</h3>
            <div class="validation-rules">
                <h4>Family Management Rules</h4>
                <ul>
                    <li>Users can only belong to one family at a time</li>
                    <li>Family maximum size is 10 members</li>
                    <li>Only family heads can invite members</li>
                    <li>Only family heads can accept/reject join requests</li>
                    <li>Only family heads can remove members</li>
                    <li>Family heads cannot remove themselves (must leave instead)</li>
                    <li>When family head leaves and members remain, first member becomes new head</li>
                    <li>Family is deleted when last member leaves</li>
                    <li>No duplicate invitations or join requests allowed</li>
                    <li>Invited users must not already belong to a family</li>
                </ul>
            </div>
        </div>

        <div class="section" id="error-handling">
            <h2>‚ö†Ô∏è Error Handling</h2>

            <h3>HTTP Status Codes</h3>
            <div class="error-responses">
                <h4>Standard Error Responses</h4>
                <ul>
                    <li><strong>400 Bad Request:</strong> Invalid input data, validation failures, business rule violations</li>
                    <li><strong>401 Unauthorized:</strong> Authentication required or invalid</li>
                    <li><strong>403 Forbidden:</strong> User lacks necessary permissions (e.g., not family head)</li>
                    <li><strong>404 Not Found:</strong> Requested resource doesn't exist (user, family, invitation, etc.)</li>
                    <li><strong>409 Conflict:</strong> Resource state conflict (user already in family, duplicate requests, etc.)</li>
                    <li><strong>500 Internal Server Error:</strong> Unexpected server errors</li>
                </ul>
            </div>

            <h3>Error Response Format</h3>
            <div class="code-block">{
  "timestamp": "2024-01-01T12:00:00Z",
  "status": 400,
  "error": "Bad Request",
  "message": "Detailed error description",
  "path": "/api/family/endpoint"
}</div>

            <h3>Common Error Scenarios</h3>
            <div class="validation-rules">
                <h4>Frequent Error Cases</h4>
                <ul>
                    <li><strong>User not in family:</strong> Attempting operations requiring family membership</li>
                    <li><strong>Not family head:</strong> Attempting head-only operations as regular member</li>
                    <li><strong>Family full:</strong> Trying to add members when family is at maximum capacity</li>
                    <li><strong>Duplicate operations:</strong> Sending duplicate invitations or join requests</li>
                    <li><strong>Invalid state:</strong> User trying to join family while already in one</li>
                    <li><strong>Missing resources:</strong> Referenced users, families, or requests don't exist</li>
                </ul>
            </div>
        </div>

        <div class="section" id="notification-system">
            <h2>üîî Notification System</h2>

            <h3>Push Notifications</h3>
            <p>The system sends Firebase Cloud Messaging (FCM) push notifications for various family events.</p>

            <h4>Notification Types</h4>
            <div class="data-models">
                <h4>Family Invitation Notifications</h4>
                <ul>
                    <li><strong>Title:</strong> "Family Invitation"</li>
                    <li><strong>Message:</strong> "You have been invited to join the family 'Family Name' by Sender Name. Please accept the invitation to join."</li>
                    <li><strong>Type:</strong> FAMILY_INVITE</li>
                    <li><strong>Actionable:</strong> Yes</li>
                </ul>
            </div>

            <div class="data-models">
                <h4>Join Request Notifications</h4>
                <ul>
                    <li><strong>Title:</strong> "Join Request"</li>
                    <li><strong>Message:</strong> "User Name (email) has requested to join your family 'Family Name'."</li>
                    <li><strong>Type:</strong> FAMILY_JOIN</li>
                    <li><strong>Actionable:</strong> No</li>
                </ul>
            </div>

            <div class="data-models">
                <h4>Request Accepted Notifications</h4>
                <ul>
                    <li><strong>Title:</strong> "Join Request Accepted" / "Invitation Accepted"</li>
                    <li><strong>Message:</strong> Various acceptance messages</li>
                    <li><strong>Type:</strong> FAMILY_JOIN</li>
                    <li><strong>Actionable:</strong> No</li>
                </ul>
            </div>

            <div class="data-models">
                <h4>Other Notifications</h4>
                <ul>
                    <li><strong>Title:</strong> "Join Request Rejected", "Invitation Cancelled", "Removed from Family"</li>
                    <li><strong>Type:</strong> FAMILY_INVITE or OTHER</li>
                    <li><strong>Actionable:</strong> No</li>
                </ul>
            </div>

            <h3>Notification Data Payload</h3>
            <div class="code-block">{
  "alias_name": "ABC123",
  "family_name": "Family Name",
  "sender_name": "sender@example.com",
  "sender_id": "sender-user-id",
  "type": "FAMILY_INVITE"
}</div>

            <h3>In-App Notifications</h3>
            <p>In addition to push notifications, the system creates in-app notifications stored in the database with the following structure:</p>

            <div class="code-block">{
  "id": "notification-uuid",
  "title": "Notification Title",
  "message": "Notification Message",
  "time": 1642099200000,
  "read": false,
  "familyId": "family-uuid",
  "senderName": "Sender Name",
  "senderId": "sender-user-id",
  "actionable": true,
  "createdAt": 1642099200000,
  "type": "FAMILY_INVITE",
  "familyAliasName": "ABC123"
}</div>

            <h3>Notification Error Handling</h3>
            <div class="validation-rules">
                <h4>Error Scenarios</h4>
                <ul>
                    <li><strong>Missing FCM Token:</strong> Logged as warning, operation continues</li>
                    <li><strong>FCM Send Failure:</strong> Logged as error, operation continues</li>
                    <li><strong>User Not Found:</strong> Notification silently skipped</li>
                    <li><strong>Database Save Failure:</strong> Logged as error, doesn't affect main operation</li>
                </ul>
            </div>
        </div>
    </div>

    <a href="#table-of-contents" class="back-to-top">‚Üë</a>

    <script>
        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Show/hide back to top button
        window.addEventListener('scroll', function() {
            const backToTop = document.querySelector('.back-to-top');
            if (window.pageYOffset > 300) {
                backToTop.style.display = 'block';
            } else {
                backToTop.style.display = 'none';
            }
        });

        // Copy code blocks to clipboard
        document.querySelectorAll('.code-block').forEach(block => {
            block.addEventListener('click', function() {
                navigator.clipboard.writeText(this.textContent).then(() => {
                    const original = this.style.background;
                    this.style.background = '#4CAF50';
                    setTimeout(() => {
                        this.style.background = original;
                    }, 200);
                });
            });
            block.style.cursor = 'pointer';
            block.title = 'Click to copy';
        });
    </script>
</body>
</html>
